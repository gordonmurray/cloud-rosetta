name: Update Cloud Database

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering
  push:
    branches: [main]
    paths:
      - 'scripts/populate_db.py'
      - '.github/workflows/update-db.yml'

jobs:
  update-database:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
    
    - name: Fetch latest pricing data
      run: |
        python scripts/fetch_pricing.py
    
    - name: Build updated database
      run: |
        python scripts/populate_db.py
        
        # Add metadata
        sqlite3 db/cloud_rosetta.db "
          INSERT INTO db_version (version, updated_at) 
          VALUES ('$(date +%Y%m%d.%H%M%S)', datetime('now'));
        "
    
    - name: Generate database stats
      run: |
        python scripts/generate_stats.py > db/STATS.md
    
    - name: Generate checksums
      run: |
        sha256sum db/cloud_rosetta.db > db/cloud_rosetta.db.sha256
        echo "Database checksum: $(cat db/cloud_rosetta.db.sha256)"
    
    - name: Commit and push if changed
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Check if database changed
        if git diff --quiet db/cloud_rosetta.db; then
          echo "No changes to database"
          exit 0
        fi
        
        # Commit changes (use -f to force add files ignored by .gitignore)
        git add -f db/cloud_rosetta.db db/STATS.md
        git commit -m "Update cloud database $(date +%Y-%m-%d)"
        git push
    
    - name: Generate version tag
      id: version
      run: |
        # Generate semantic version: YYYY.MM.DD-BUILD
        VERSION=$(date +%Y.%m.%d)-${{ github.run_number }}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"
    
    - name: Create Release (weekly)
      if: github.event.schedule && contains('0 2 * * 0', github.event.schedule)  # Sundays
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Database Release v${{ steps.version.outputs.version }}
        body_path: db/STATS.md
        files: |
          db/cloud_rosetta.db
          db/cloud_rosetta.db.sha256
          db/STATS.md
        
    - name: Create Latest Release Tag
      if: github.event.schedule && contains('0 2 * * 0', github.event.schedule)
      run: |
        git tag -f latest
        git push origin latest --force